#!/usr/bin/env bash

# TODO: try to move services to package folders for better organisation

__services_base="${1:?"A services base directory is required"}"
__services_config="${@:2}"

##
# Defines available config.
##
__services::define_config() {
    local key
    local value

    for item in ${__services_config[*]}; do
        [[ "$item" =~ ^(.*)=(.*)$ ]]
        key="$(echo ${BASH_REMATCH[1]} | sed "s/_/-/g")"
        value="${BASH_REMATCH[2]}"

        container::add "$key" "$value"
    done
}

##
# Defines available parameters.
##
__services::define_parameters() {
    container::add "config-dir" "$__services_base/config"
    container::add "lib-dir" "$__services_base/lib"
    container::add "src-dir" "$__services_base/src"

    # add all src dirs as container parameters
    for dir in $(find "$__services_base/src" -mindepth 1 -maxdepth 1 -type d); do
        container::add "$(basename $dir)-dir" "$dir"
    done

    # logging channels
    container::add "stdout-channel" $(tty)
    container::add "file-channel" $(container::resolve "@log-dir::/$(date '+%Y-%m-%d').log")

    # pipes
    container::add "excluding-pipe" $(container::resolve "@org-tmp::/excluding-pipe")

    # message routing
    local excluding_pipe=$(container::resolve "@excluding-pipe")
    container::add "message-routing" \
        "--" \
            "@kill-message::$excluding_pipe" \
            "@publish-message::$excluding_pipe" \
            "@report-message::$excluding_pipe"

    # publishable topics
    container::add "time-machine-exclude-topic" "time-machine-exclude"

    # watchexec producer events
    container::add "excluding-producer-events" "--" "created" "renamed"

    # publish action subscribers
    local tm_exclude_topic=$(container::resolve "@time-machine-exclude-topic")
    container::add "publish-action-subscribers" \
        "--" \
            "@excluding-subscriber::$tm_exclude_topic" \
            "@excluding-notification-subscriber::$tm_exclude_topic"
}

##
# Defines available services.
##
__services::define_services() {
    # Aliases for config items that resolve to valid file paths will not be
    # sourced and, therefore, not resolve at runtime; they must be resolved
    # here.

    # lib
    container::add "file-logger" \
        "$__services_base/lib/log-slog/index" \
            "@log-level" \
            $(container::resolve "@file-channel")

    container::add "stdout-logger" \
        "$__services_base/lib/log-slog/index" \
            "@log-level" \
            $(container::resolve "@stdout-channel") \
            "->"

    container::add "bash-clash" \
        "$__services_base/lib/bash-clash/index"

    # commands
    container::add "app-command" \
        "$__services_base/src/command/app-command" \
            "@queue-command" \
            "@services-command" \
            "@watch-command"

    container::add "queue-command" \
        "$__services_base/src/command/queue-command" \
            "@consume-feature" \
            "@message-feature" \
            "@produce-feature"

    container::add "services-command" \
        "$__services_base/src/command/services-command"

    container::add "watch-command" \
        "$__services_base/src/command/watch-command" \
            "@watch-feature" \
            $(container::resolve "@profiles-dir") \
            $HOME

    # features
    container::add "consume-feature" \
        "$__services_base/src/feature/consume-feature" \
            "@excluding-consumer"

    container::add "message-feature" \
        "$__services_base/src/feature/message-feature" \
            "@message-bus" \
            "@stdout-logger"

    container::add "produce-feature" \
        "$__services_base/src/feature/produce-feature" \
            "@excluding-producer" \
            "@stdout-logger"

    container::add "watch-feature" \
        "$__services_base/src/feature/watch-feature" \
            "@profile-manager" \
            "@excluding-consumer" \
            "@message-bus" \
            "@stdout-logger" \
            $(container::resolve "@debug")

    # consumers
    container::add "excluding-consumer" \
        "$__services_base/src/service/queue/consumer" \
            "@excluding-pipe" \
            "@stdout-logger" \
            "@message-handler"

    # file profilers
    container::add "profile-parser" \
        "$__services_base/src/service/profile/profile-parser"

    container::add "profile-manager" \
        "$__services_base/src/service/profile/profile-manager" \
            "@profile-parser" \
            "@stdout-logger"

    container::add "watchexec-tester" \
        "$__services_base/src/service/profile/tester/watchexec-tester"

    container::add "predicate-tester" \
        "$__services_base/src/service/profile/tester/predicate-tester"

    container::add "profile-matcher" \
        "$__services_base/src/service/profile/profile-matcher" \
            "@profile-manager" \
            "@watchexec-tester" \
            "@predicate-tester" \
            "@stdout-logger"

    # producers
    container::add "excluding-producer" \
        "$__services_base/src/service/queue/producer" \
            "@stdout-logger" \
            "@message-bus" \
            "@time-machine-exclude-topic" \
            "@profile-matcher" \
            "@excluding-producer-events"

    # buses
    container::add "message-bus" \
        "$__services_base/src/bus/message-bus" \
            "@stdout-logger" \
            "@message-routing"

    # messages
    container::add "kill-message" \
        "$__services_base/src/message/kill-message"

    container::add "publish-message" \
        "$__services_base/src/message/publish-message"

    container::add "report-message" \
        "$__services_base/src/message/report-message"


    # handlers
    container::add "message-handler" \
        "$__services_base/src/handler/message-handler" \
            "@stdout-logger"

    # actions
    container::add "kill-action" \
        "$__services_base/src/action/kill-action" \
            "@bash-clash" \
            "@stdout-logger"

    container::add "publish-action" \
        "$__services_base/src/action/publish-action" \
            "@stdout-logger" \
            "@bash-clash" \
            "@publish-action-subscribers"

    container::add "report-action" \
        "$__services_base/src/action/report-action" \
            "@bash-clash" \
            "@view-dir"

    # subscribers
    container::add "excluding-subscriber" \
        "$__services_base/src/subscriber/excluding-subscriber" \
            "@bash-clash" \
            "@stdout-logger"

    container::add "excluding-notification-subscriber" \
        "$__services_base/src/subscriber/notifying-subscriber" \
            "@stdout-logger" \
            "@excluding-notification"

    # notifications
    container::add "excluding-notification" \
        "$__services_base/src/notification/excluding-notification" \
            "@bash-clash"
}

##
# Defines all configured services.
##
services::define() {
    __services::define_config
    __services::define_parameters
    __services::define_services

    unset __services_base
    unset __services_config
}
