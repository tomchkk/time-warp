#!/usr/bin/env bash

__script=$(readlink "${BASH_SOURCE[0]}" || echo "${BASH_SOURCE[0]}")
__project_dir="$(cd $(dirname "$__script"); pwd)"

APP_VERSION="$(cat $__project_dir/version)"

source "$__project_dir/.env"

APP_NAME="${APP_NAME:-$(basename $0)}"
APP_ENV="${APP_ENV:-dev}"
DEBUG="${DEBUG:-true}"
LOG_LEVEL="${LOG_LEVEL:-DEBUG}"

__submodules_dir="$__project_dir/submodules"
__var_dir="$__project_dir/var"
__cache_dir="$__var_dir/cache"
__log_dir="$__var_dir/log"
__profiles_dir="$HOME/.config/$APP_NAME/profiles"
__org_tmp="/tmp/${ORG_ID:-com.org}.$APP_NAME"

__make_run=(
    --file="$__project_dir/Makefile"
    --warn-undefined-variables
    run
    var_dir="$__var_dir"
    cache_dir="$__cache_dir"
    log_dir="$__log_dir"
    org_tmp="$__org_tmp"
)

# build all the files that will be needed for the project to work
make ${__make_run[@]}

source "$__project_dir/src/kernel" $APP_ENV $DEBUG $@
