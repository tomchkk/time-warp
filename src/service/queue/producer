#!/usr/bin/env bash

__producer_logger=${1:?"A logger is required"}
__producer_bus=${2:?"A message bus is required"}
__producer_topic=${3:?"A publishable topic is required"}
__producer_profile_matcher=${4:?"A profile matcher is required"}
__producer_watching=${@:5}

source $__producer_logger

if [[ -z "$__producer_watching" ]]; then
    log::error "No events to watch are defined" && exit 1
fi

##
# Determines if the given event is being watched.
#
__producer::event_is_watched() {
    if $(printf '%s\n' ${__producer_watching[@]} | grep -q -E ^$1$); then
        return 0
    fi

    return 1
}

##
# Produces publishable topic messages into the given message bus.
#
producer::produce() {
    local path_profiles=${1:?"A path profile is required"}

    local events=('created' 'removed' 'renamed' 'written' 'meta')
    local modifications=(
        'WATCHEXEC_CREATED_PATH'
        'WATCHEXEC_REMOVED_PATH'
        'WATCHEXEC_RENAMED_PATH'
        'WATCHEXEC_WRITTEN_PATH'
        'WATCHEXEC_META_CHANGED_PATH'
    )

    for key in ${!modifications[*]}; do
        local event="${events[$key]}"
        local modification="${modifications[$key]}"
        # TODO: fix this (with tests)
        # - it will certainly fail when one of the paths contains a space...
        local paths=($(echo "${!modification}" | sed -E 's/:/ /g'))

        if [[ -z "$paths" ]]; then
            log::debug "Producer was called, but no watchexec modifications were detected."

            return 0
        fi

        if $(__producer::event_is_watched $event); then
            log::debug "Watched event '$event' was fired"

            # now that shit is getting real, let's charge our weapons!
            source $__producer_profile_matcher "$path_profiles"
            source $__producer_bus

            local path
            for path in ${paths[@]}; do
                # $path will be a path stub if $WATCHEXEC_COMMON_PATH is set,
                # otherwise it will be a full path. So, either way, the two can
                # be concatenated to get a full path to a changed file
                path="${WATCHEXEC_COMMON_PATH}${path}"

                log::debug "Detected modification to '$path'."

                if $(matcher::match $path); then
                    log::debug "Matcher matched path '$path'"

                    message_bus::dispatch_message "PUBLISH" --topic $__producer_topic --path $path
                else
                    log::debug "Matcher did not match path '$path'"
                fi
            done
        else
            log::debug "Ignoring '$event' event: not watched."
        fi
    done
}
