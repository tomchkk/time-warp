#!/usr/bin/env bash

messages="$1"
# TODO: should the target be configurable in the container?
logger="$2 $3" && source $logger "$(tty)"

shift 3
routing="$@"

if [[ ! -d "$messages" ]]; then
    __log_error "An existing message directory is required" && exit 1
fi

if [[ -z "$routing" ]]; then
    __log_error "No message routing is defined" && exit 1
fi

__dispatch_message() {
    local action="${1:-[empty]}"

    local message="$messages/$(echo $action | tr '[:upper:]' '[:lower:]')-message"

    if [[ ! -f "$message" ]]; then
        __log_error "A message could not be found for the '$action' action."
        exit 1
    fi

    local target
    for route in ${routing[*]}; do
        if [[ "$route" == "$message::"* ]]; then
            target=$(echo "$route" | sed -E "s/.*::(.*)/\1/") && break;
        fi
    done

    if [[ -z "$target" ]]; then
        __log_error "A message route is not defined for the '$action' message."
        exit 1
    fi

    if [[ ! -e "$target" ]]; then
        __log_error " The target '$target' does not exist." && exit 1
    fi

    source $message && __send_message > $target

    __log_info "'$action' message was dispatched."
}
