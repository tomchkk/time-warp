#!/usr/bin/env bash

__command_usage() {
    cat << EOF
$app_name ($version) - Queue

Consume or produce $app_name queue items.

Usage:  $app_name queue [options] <args>

Options:
    -h, --help      Print usage information
    -c, --consume   Open a FIFO pipe to consume items pushed to the queue
    -k, --kill      Kill running queue services
    -l, --list      List running queue services
    -p, --produce   Produce queue items

EOF
}

pipe=$(__container_get "excluding-pipe")
bus=$(__container_get "message-bus")

opt="$1" && shift
args="$@"

case "$opt" in
    -c|--consume)
        source $(__container_get "excluding-consumer")
    ;;
    -k|--kill)
        source $bus && echo $(__dispatch_message KILL)
    ;;
    -l|--list)
        echo "list running queue services..."
    ;;
    -r|--report)
        source $bus && echo $(__dispatch_message REPORT)
    ;;
    -p|--produce)
        # - runs `watchexec --resolved-options -- /path/2/producer`
        #   - watches for changes to given paths gets filters from profiles
        #   - ignores changes caused by itself
        #   - passes normalised path to `time-warp match $path` to match the path to a
        #     configured profile
        #   - on successful match, pushes message (timestamp and path) to time-warp/excluding.q file

        # watchexec \
        #     --watch /Users/tom/ \
        #     --filter '**/vendor' \
        #     --ignore '**/vendor/**/vendor/**' \
        #     --no-vcs-ignore \
        #     --no-default-ignore \
        #     --no-shell \
        #     -- "$service/queue/producer"
    ;;
    -h|--help|*)
        __command_usage && exit 0
    ;;
esac
