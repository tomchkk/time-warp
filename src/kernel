#!/usr/bin/env bash

# build an array of config
__kernel_config=(
    app_env="${1:?"APP_ENV is required"}"
    debug="${2:?"DEBUG must be set"}"
    user_config="$__user_config"
    profiles_dir="$__profiles_dir"
    var_dir="$__var_dir"
    log_dir="$__log_dir"
    org_tmp="$__org_tmp"
    log_level="${LOG_LEVEL:-"DEBUG"}"
)
__kernel_args=${@:3}

# import container functionality
source "$__submodules_dir/tomchkk/bash-container/index"

# boot app config, parameters and services
source "$__project_dir/config/services" "$__project_dir" ${__kernel_config[*]}
services::define

# extend the 'source' builtin with dependency-loader functionality
source $bash_container_loader @file-logger

# handle the request
source @app-command $__kernel_args

unset \
    __kernel_config \
    __kernel_args
